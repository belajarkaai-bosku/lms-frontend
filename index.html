<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LMS Sekolah â€¢ Supabase Mode Sekolah</title>

  <style>
    :root{
      --blue:#2563eb;
      --blueDark:#1d4ed8;
      --text:#0f172a;
      --muted:#475569;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e5e7eb;
      --radius:18px;
      --shadow: 0 14px 40px rgba(2, 6, 23, .08);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.5;
    }
    a{ color:inherit; text-decoration:none; }
    img{ max-width:100%; display:block; }
    .container{ width:min(1100px, 92%); margin:0 auto; }

    /* ===== HEADER ===== */
    .site-header{
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(248,250,252,.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 12px 0;
    }
    .brand{ display:flex; align-items:center; gap: 12px; font-weight: 900; }
    .brand-title{ font-size: 14px; font-weight: 900; }
    .brand-sub{ font-size: 12px; color: var(--muted); font-weight: 700; }
    .school-logo{
      width: 42px;
      height: 42px;
      object-fit: contain;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .pill{
      font-size: 12px;
      font-weight: 900;
      padding: 8px 12px;
      border-radius: 999px;
      background: #dbeafe;
      color:#1e40af;
      border: 1px solid #bfdbfe;
      white-space: nowrap;
    }

    .hamburger{
      display:none;
      border: 1px solid var(--border);
      background:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
    }

    /* ===== BUTTONS ===== */
    .actions{ display:flex; gap: 10px; flex-wrap: wrap; }
    .btn{
      border: 1px solid var(--border);
      background: var(--blue);
      color:#fff;
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 25px rgba(37,99,235,.22);
    }
    .btn:hover{ background: var(--blueDark); }
    .btn.secondary{
      background:#fff;
      color: var(--blue);
      border-color:#bfdbfe;
      box-shadow:none;
    }
    .btn.secondary:hover{ background:#eff6ff; }

    /* ===== CARDS ===== */
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .muted{ color: var(--muted); margin:0; }
    h1,h2,h3{ margin:0 0 10px; }

    /* ===== AUTH ===== */
    #authWrap{ padding: 18px 0 8px; }
    .auth-card{ padding: 18px; }

    label{ font-weight: 800; font-size: 13px; color: var(--muted); }
    input, textarea, select{
      width: 100%;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      font: inherit;
      outline: none;
      background:#fff;
    }
    textarea{ min-height: 120px; resize: vertical; }
    .form{ display:grid; gap: 10px; margin-top: 12px; }

    /* ===== APP LAYOUT ===== */
    #appContent{ display:none; padding: 10px 0 28px; }

    .layout{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
      padding: 10px 0 10px;
    }

    .sidebar{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      height: fit-content;
      position: sticky;
      top: 82px;
    }

    .side-title{
      font-weight: 900;
      margin: 0 0 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }

    .badge{
      display:inline-flex;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #bfdbfe;
      background:#eff6ff;
      color:#1e40af;
      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
      height: fit-content;
    }

    .menu-group{
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .4px;
      color: var(--muted);
      margin: 6px 0 10px;
      padding: 8px 10px;
      border: 1px dashed #cbd5e1;
      border-radius: 14px;
      background: #f8fafc;
    }

    .menu{
      display:flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }

    .menu button{
      width: 100%;
      text-align: left;
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 900;
      color: var(--muted);
      position: relative;
      transition: transform .05s ease;
    }
    .menu button:hover{ background:#eff6ff; color: var(--text); border-color:#bfdbfe; }
    .menu button:active{ transform: scale(.99); }
    .menu button.active{
      background: var(--blue);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 10px 25px rgba(37,99,235,.22);
    }
    .menu button.active::before{
      content:"";
      position:absolute;
      left: 10px;
      top: 10px;
      bottom: 10px;
      width: 4px;
      border-radius: 99px;
      background: rgba(255,255,255,.9);
    }

    main{ display:grid; gap: 14px; }

    .page-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .list{ display:grid; gap: 10px; margin-top: 12px; }
    .item{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background:#fff;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .meta{ color: var(--muted); font-size: 13px; margin-top: 6px; }

    .filebox{
      border: 1px dashed #cbd5e1;
      border-radius: 16px;
      background:#fafafa;
      padding: 12px;
      display:grid;
      gap: 8px;
    }
    .filehint{ font-size: 13px; color: var(--muted); }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* overlay drawer */
    .overlay{
      display:none;
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.35);
      z-index: 40;
    }
    .side-footer{
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    @media (max-width: 900px){
      .layout{ grid-template-columns: 1fr; }
      .hamburger{ display:inline-flex; align-items:center; gap:8px; }
      .sidebar{
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: min(320px, 86vw);
        border-radius: 0 18px 18px 0;
        z-index: 50;
        transform: translateX(-110%);
        transition: transform .18s ease;
        overflow: auto;
        padding-top: 18px;
      }
      .sidebar.open{ transform: translateX(0); }
      .overlay.open{ display:block; }
      .row2{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="container topbar">
      <div class="brand">
        <img src="logo-sekolah.png" alt="Logo Duruusul Quran Islamic School Makassar" class="school-logo">
        <div>
          <div class="brand-title">LMS Sekolah</div>
          <div class="brand-sub">Supabase â€¢ Mode Sekolah</div>
        </div>
      </div>

      <div class="top-actions">
        <button class="hamburger" id="btnMenu" type="button" aria-label="Buka menu">â˜°</button>
        <span class="pill" id="rolePill">Role: -</span>
        <span class="pill" id="userPill">User: -</span>
        <button class="btn secondary" id="btnLogoutTop" type="button" style="display:none;">Logout</button>
      </div>
    </div>
  </header>

  <!-- AUTH -->
  <section class="container" id="authWrap">
    <div class="card auth-card" id="authBox">
      <h2>Login LMS</h2>
      <p class="muted" id="authStatus">Silakan login untuk mengakses LMS.</p>

      <div class="form" style="max-width:520px;">
        <div>
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="email@sekolah.sch.id" />
        </div>
        <div>
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="actions">
          <button class="btn" id="btnLogin" type="button">Login</button>
          <button class="btn secondary" id="btnLogout" type="button" style="display:none;">Logout</button>
        </div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <div id="appContent">
    <div class="container">
      <div class="layout">
        <div class="overlay" id="overlay"></div>

        <aside class="sidebar" id="sidebar">
          <div class="side-title">
            <span>Menu</span>
            <span class="badge" id="menuHint">-</span>
          </div>

          <div class="menu-group" id="menuGroupTitle">Siswa</div>
          <div class="menu" id="menu"></div>

          <div class="side-footer">
            <small class="muted">Â© LMS Sekolah</small>
          </div>
        </aside>

        <main>
          <div class="page-head">
            <div>
              <h1 id="pageTitle">Dashboard</h1>
              <p class="muted" id="pageDesc">Ringkasan dan informasi.</p>
            </div>
          </div>

          <section class="card" id="page"></section>

          <section class="card">
            <h3>Catatan</h3>
            <p class="muted">
              File tugas/materi disimpan di <b>Supabase Storage</b> (permanen) dan aksesnya memakai <b>signed URL</b>.
            </p>
          </section>
        </main>
      </div>
    </div>
  </div>

  <!-- SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /***********************
     * 1) KONFIGURASI SUPABASE
     ***********************/
    const SUPABASE_URL = "https://ptnzvzcnmcrbgbmkuvzd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0bnp2emNubWNyYmdibWt1dnpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4NDMzNjAsImV4cCI6MjA4NDQxOTM2MH0.JT-jD31hOeo5-HHDLyGXPtDbOCxA5wvC52rV6OQoBmo";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * 2) DATA & KONSTANTA
     ***********************/
    const MAPEL_ORDER = [
      "Bahasa Indonesia",
      "PKN",
      "Hadits",
      "Bahasa Inggris",
      "PJOK",
      "IPA",
      "IPS",
      "Matematika",
      "Tajwid",
      "Prakarya",
      "Diniyah",
      "Bahasa Arab",
    ];
    const DINIYAH_SUB_ORDER = ["Aqidah", "Fiqih", "Tafsir", "Siroh", "Khot"];

    // menu role
    const menus = {
      siswa: [
        { key: "dashboard", label: "Dashboard" },
        { key: "tugas", label: "Tugas" },
        { key: "materi", label: "Materi" },
      ],
      guru: [
        { key: "berikan-dashboard", label: "Pengumuman" },
        { key: "berikan-tugas", label: "Berikan Tugas" },
        { key: "berikan-materi", label: "Berikan Materi" },
      ]
    };

    // state global
    const sample = { tugas: [], materi: [] };
    let currentRole = null; // 'guru'/'siswa'
    let state = { role: "siswa", page: "dashboard" };

    /***********************
     * 3) ELEMEN DOM
     ***********************/
    const rolePill = document.getElementById("rolePill");
    const userPill = document.getElementById("userPill");
    const menuHint = document.getElementById("menuHint");
    const menuGroupTitle = document.getElementById("menuGroupTitle");
    const menuEl = document.getElementById("menu");
    const pageEl = document.getElementById("page");

    const authStatus = document.getElementById("authStatus");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnLogoutTop = document.getElementById("btnLogoutTop");

    const btnMenu = document.getElementById("btnMenu");
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");

    /***********************
     * 4) HELPERS UI
     ***********************/
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatBytes(bytes){
      if (!Number.isFinite(bytes)) return "-";
      const units = ["B","KB","MB","GB"];
      let i = 0, n = bytes;
      while (n >= 1024 && i < units.length - 1){
        n = n / 1024; i++;
      }
      return n.toFixed(i === 0 ? 0 : 1) + " " + units[i];
    }

    function setPageHeader(title, desc){
      document.getElementById("pageTitle").textContent = title;
      document.getElementById("pageDesc").textContent = desc;
    }

    function openMenu(){
      sidebar.classList.add("open");
      overlay.classList.add("open");
    }
    function closeMenu(){
      sidebar.classList.remove("open");
      overlay.classList.remove("open");
    }

    /***********************
     * 5) SUPABASE STORAGE (UPLOAD & DOWNLOAD)
     ***********************/
    async function uploadToSupabase(bucket, folder, file){
      const ext = file.name.includes(".") ? file.name.split(".").pop() : "";
      const safeExt = ext ? "." + ext : "";
      const path = `${folder}/${Date.now()}-${Math.random().toString(16).slice(2)}${safeExt}`;

      const { error } = await supabaseClient.storage.from(bucket).upload(path, file, { upsert: false });
      if (error) throw error;

      return { file_path: path, file_name: file.name, file_size: file.size };
    }

    // download pakai signed URL (10 menit)
    async function openDownload(bucket, file_path){
      try{
        const { data, error } = await supabaseClient.storage.from(bucket).createSignedUrl(file_path, 60 * 10);
        if (error) throw error;
        window.open(data.signedUrl, "_blank");
      }catch(e){
        alert("Gagal download: " + (e?.message || String(e)));
      }
    }

    /***********************
     * 6) AUTH & ROLE
     ***********************/
    async function fetchMyRole(){
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) return null;

      const { data, error } = await supabaseClient
        .from("profiles")
        .select("role, full_name")
        .eq("id", user.id)
        .single();

      if (error) throw error;
      return data?.role || "siswa";
    }

    async function loadTugasMateri(){
      const { data: tugas, error: e1 } = await supabaseClient
        .from("tugas").select("*").order("created_at", { ascending: false });
      if (e1) throw e1;

      const { data: materi, error: e2 } = await supabaseClient
        .from("materi").select("*").order("created_at", { ascending: false });
      if (e2) throw e2;

      sample.tugas = tugas || [];
      sample.materi = materi || [];
    }

    async function refreshUIAfterLogin(){
      currentRole = await fetchMyRole(); // guru / siswa
      const { data: { user } } = await supabaseClient.auth.getUser();

      // set badges header
      const rLabel = (currentRole === "guru") ? "Guru" : "Siswa";
      rolePill.textContent = "Role: " + rLabel;
      menuHint.textContent = rLabel;
      menuGroupTitle.textContent = rLabel;
      userPill.textContent = "User: " + (user?.email || "-");

      // set menu state
      state.role = (currentRole === "guru") ? "guru" : "siswa";
      state.page = (state.role === "guru") ? "berikan-dashboard" : "dashboard";

      await loadTugasMateri();
      renderMenu();
      renderPage();

      // show app
      document.getElementById("appContent").style.display = "block";
      authStatus.textContent = "âœ… Login berhasil.";
    }

    async function updateButtons(){
      const { data: { user } } = await supabaseClient.auth.getUser();
      btnLogin.style.display = user ? "none" : "inline-block";
      btnLogout.style.display = user ? "inline-block" : "none";
      btnLogoutTop.style.display = user ? "inline-block" : "none";
    }

    /***********************
     * 7) MENU & PAGE RENDER
     ***********************/
    function setPage(key){
      state.page = key;
      renderMenu();
      renderPage();
    }

    function renderMenu(){
      menuEl.innerHTML = "";
      menus[state.role].forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item.label;
        btn.className = item.key === state.page ? "active" : "";
        btn.addEventListener("click", () => setPage(item.key));
        menuEl.appendChild(btn);
      });
    }

    // ===== Pages Siswa =====
    function pageSiswaDashboard(){
      const totalTugas = sample.tugas.length;
      const tugasDenganFile = sample.tugas.filter(t => t.file_path).length;

      return `
        <h2>Ringkasan</h2>
        <p class="muted">Ringkasan tugas dan file yang tersedia.</p>

        <div class="list">
          <div class="item">
            <div>
              <strong>Total Tugas</strong>
              <div class="meta">${totalTugas} tugas</div>
            </div>
            <span class="badge">Info</span>
          </div>

          <div class="item">
            <div>
              <strong>Tugas dengan File</strong>
              <div class="meta">${tugasDenganFile} tugas ada lampiran</div>
            </div>
            <span class="badge">File</span>
          </div>
        </div>
      `;
    }

    function pageSiswaTugas(){
      const rows = (sample.tugas || []).map((t) => {
        const filePart = t.file_path
          ? `
              <div class="meta">
                <button class="btn secondary" type="button"
                  onclick="openDownload('lms-files','${escapeHtml(t.file_path)}')">
                  â¬‡ Download: ${escapeHtml(t.file_name || 'Lampiran')}
                </button>
              </div>
              <div class="meta">Ukuran: ${formatBytes(Number(t.file_size) || 0)}</div>
            `
          : `<div class="meta">Lampiran: -</div>`;

        return `
          <div class="item">
            <div>
              <strong>${escapeHtml(t.judul)}</strong>
              <div class="meta">Deadline: ${escapeHtml(t.deadline || "-")}</div>
              <div class="meta">Deskripsi: ${escapeHtml(t.deskripsi || "-")}</div>
              ${filePart}
            </div>
            <span class="badge">Tugas</span>
          </div>
        `;
      }).join("");

      return `
        <h2>Daftar Tugas</h2>
        <p class="muted">Daftar tugas. Jika ada file, kamu bisa download.</p>
        <div class="list">${rows || `<p class="muted">Belum ada tugas.</p>`}</div>
      `;
    }

    function pageSiswaMateri(){
      // group by mapel
      const grouped = new Map();
      (sample.materi || []).forEach(m => {
        const mapel = m.mapel || "Lainnya";
        if (!grouped.has(mapel)) grouped.set(mapel, []);
        grouped.get(mapel).push(m);
      });

      function renderMateriItems(arr){
        const sorted = [...arr].sort((a,b) => String(b.tanggal||"").localeCompare(String(a.tanggal||"")));
        return sorted.map(m => `
          <div class="item">
            <div>
              <strong>${escapeHtml(m.judul)}</strong>
              <div class="meta">Tipe: ${escapeHtml(m.tipe || "-")}</div>
              <div class="meta">Tanggal: ${escapeHtml(m.tanggal || "-")}</div>
              ${m.link ? `<div class="meta"><a class="btn secondary" href="${escapeHtml(m.link)}" target="_blank" rel="noopener">ðŸ”— Buka Link</a></div>` : ""}
              ${m.file_path ? `
                <div class="meta">
                  <button class="btn secondary" type="button"
                    onclick="openDownload('lms-files','${escapeHtml(m.file_path)}')">
                    â¬‡ Download: ${escapeHtml(m.file_name || 'Lampiran')}
                  </button>
                </div>
                <div class="meta">Ukuran: ${formatBytes(Number(m.file_size) || 0)}</div>
              ` : ""}
            </div>
            <span class="badge">Materi</span>
          </div>
        `).join("");
      }

      function renderMapelBlock(mapelName){
        const arr = grouped.get(mapelName) || [];
        if (arr.length === 0) return "";
        return `
          <div style="margin-top:14px;">
            <h3 style="margin:0 0 8px;">${escapeHtml(mapelName)}</h3>
            <div class="list">${renderMateriItems(arr)}</div>
          </div>
        `;
      }

      function renderDiniyahBlock(){
        const arr = grouped.get("Diniyah") || [];
        if (arr.length === 0) return "";

        const subGrouped = new Map();
        arr.forEach(m => {
          const sub = (m.sub || "Lainnya").trim();
          if (!subGrouped.has(sub)) subGrouped.set(sub, []);
          subGrouped.get(sub).push(m);
        });

        const subs = [
          ...DINIYAH_SUB_ORDER.filter(s => subGrouped.has(s)),
          ...[...subGrouped.keys()].filter(s => !DINIYAH_SUB_ORDER.includes(s)),
        ];

        const subBlocks = subs.map(sub => `
          <div style="margin-top:10px; padding:12px; border:1px solid var(--border); border-radius:16px; background:#fff;">
            <strong style="display:block; margin-bottom:8px;">${escapeHtml(sub)}</strong>
            <div class="list">${renderMateriItems(subGrouped.get(sub))}</div>
          </div>
        `).join("");

        return `
          <div style="margin-top:14px;">
            <h3 style="margin:0 0 8px;">Diniyah</h3>
            ${subBlocks}
          </div>
        `;
      }

      const blocks = MAPEL_ORDER
        .filter(m => m !== "Diniyah")
        .map(renderMapelBlock)
        .join("");

      const diniyah = renderDiniyahBlock();
      const totalMateri = (sample.materi || []).length;

      return `
        <h2>Materi</h2>
        <p class="muted">Materi dikelompokkan berdasarkan mata pelajaran.</p>
        ${totalMateri === 0 ? `<p class="muted" style="margin-top:10px;">Belum ada materi.</p>` : ""}
        ${blocks}
        ${diniyah}
      `;
    }

    // ===== Pages Guru =====
    function pageGuruBerikanDashboard(){
      return `
        <h2>Pengumuman</h2>
        <p class="muted">Contoh halaman untuk menulis pengumuman (demo).</p>

        <form class="form" onsubmit="return false;">
          <div>
            <label>Judul Pengumuman</label>
            <input id="annTitle" placeholder="Contoh: Ulangan Pekan Ini" />
          </div>
          <div>
            <label>Isi Pengumuman</label>
            <textarea id="annBody" placeholder="Tulis informasi untuk siswa..."></textarea>
          </div>
          <div class="actions">
            <button class="btn" id="btnAnn" type="button">Publikasikan</button>
            <button class="btn secondary" type="reset">Reset</button>
          </div>
          <p class="muted" id="annMsg" style="margin-top:8px;"></p>
        </form>
      `;
    }

    function pageGuruBerikanTugas(){
      return `
        <h2>Berikan Tugas</h2>
        <p class="muted">Isi judul + deadline + upload lampiran (pdf/doc/zip/dll).</p>

        <form class="form" onsubmit="return false;">
          <div>
            <label>Judul Tugas</label>
            <input id="taskTitle" placeholder="Contoh: Tugas IPA Bab 2" />
          </div>

          <div>
            <label>Deadline</label>
            <input id="taskDeadline" type="date" />
          </div>

          <div class="filebox">
            <label>Upload File Lampiran</label>
            <input id="taskFile" type="file" />
            <div class="filehint">File disimpan di Supabase Storage (permanen). Hanya guru boleh upload.</div>
          </div>

          <div>
            <label>Deskripsi (opsional)</label>
            <textarea id="taskDesc" placeholder="Instruksi tugas..."></textarea>
          </div>

          <div class="actions">
            <button class="btn" id="btnTask" type="button">Tambahkan Tugas</button>
            <button class="btn secondary" type="reset">Reset</button>
          </div>

          <p class="muted" id="taskMsg" style="margin-top:8px;"></p>
        </form>
      `;
    }

    function pageGuruBerikanMateri(){
      const mapelOptions = MAPEL_ORDER.map(m => `<option value="${m}">${m}</option>`).join("");
      const diniyahOptions = DINIYAH_SUB_ORDER.map(s => `<option value="${s}">${s}</option>`).join("");

      return `
        <h2>Berikan Materi</h2>
        <p class="muted">Tambah materi (judul + mapel + tipe + link/konten) + upload file (opsional).</p>

        <form class="form" onsubmit="return false;">
          <div>
            <label>Judul Materi</label>
            <input id="matTitle" placeholder="Contoh: Sistem Pencernaan" />
          </div>

          <div class="row2">
            <div>
              <label>Mata Pelajaran</label>
              <select id="matMapel">${mapelOptions}</select>
            </div>

            <div id="diniyahWrap" style="display:none;">
              <label>Sub Diniyah</label>
              <select id="matSub">${diniyahOptions}</select>
            </div>
          </div>

          <div>
            <label>Tipe Materi</label>
            <input id="matType" placeholder="Contoh: PDF / Video / Slide" />
          </div>

          <div class="filebox">
            <label>Upload File Materi (opsional)</label>
            <input id="matFile" type="file" />
            <div class="filehint">Jika upload, siswa bisa download dengan signed URL.</div>
          </div>

          <div>
            <label>Link / Konten</label>
            <textarea id="matLink" placeholder="Tempel link Google Drive / YouTube / teks materi..."></textarea>
          </div>

          <div class="actions">
            <button class="btn" id="btnMat" type="button">Tambahkan Materi</button>
            <button class="btn secondary" type="reset">Reset</button>
          </div>

          <p class="muted" id="matMsg" style="margin-top:8px;"></p>
        </form>
      `;
    }

    function renderPage(){
      const r = state.role;
      const p = state.page;

      if (r === "siswa"){
        if (p === "dashboard") { setPageHeader("Dashboard", "Ringkasan tugas dan materi."); pageEl.innerHTML = pageSiswaDashboard(); }
        if (p === "tugas") { setPageHeader("Tugas", "Daftar tugas dan lampiran."); pageEl.innerHTML = pageSiswaTugas(); }
        if (p === "materi") { setPageHeader("Materi", "Materi dikelompokkan per mata pelajaran."); pageEl.innerHTML = pageSiswaMateri(); }
      } else {
        if (p === "berikan-dashboard") { setPageHeader("Pengumuman", "Buat pengumuman untuk siswa."); pageEl.innerHTML = pageGuruBerikanDashboard(); }
        if (p === "berikan-tugas") { setPageHeader("Berikan Tugas", "Upload tugas + lampiran."); pageEl.innerHTML = pageGuruBerikanTugas(); }
        if (p === "berikan-materi") { setPageHeader("Berikan Materi", "Tambah materi per mapel + upload file."); pageEl.innerHTML = pageGuruBerikanMateri(); }
      }

      wireHandlers();
    }

    /***********************
     * 8) EVENT HANDLERS PER HALAMAN
     ***********************/
    function wireHandlers(){
      // publish pengumuman (demo)
      const btnAnn = document.getElementById("btnAnn");
      if (btnAnn){
        btnAnn.addEventListener("click", () => {
          const title = document.getElementById("annTitle").value.trim();
          const body = document.getElementById("annBody").value.trim();
          const msg = document.getElementById("annMsg");

          if (!title || !body){
            msg.textContent = "Judul dan isi pengumuman wajib diisi.";
            return;
          }
          msg.textContent = "âœ… Pengumuman dipublikasikan (demo).";
        });
      }

      // tambah tugas (supabase)
      const btnTask = document.getElementById("btnTask");
      if (btnTask){
        btnTask.addEventListener("click", async () => {
          const title = document.getElementById("taskTitle").value.trim();
          const deadline = document.getElementById("taskDeadline").value;
          const desc = document.getElementById("taskDesc").value.trim();
          const fileInput = document.getElementById("taskFile");
          const msg = document.getElementById("taskMsg");

          if (!title || !deadline){
            msg.textContent = "Judul dan deadline wajib diisi.";
            return;
          }

          msg.textContent = "Mengupload...";
          try{
            const file = fileInput?.files?.[0];
            let fileMeta = {};
            if (file) fileMeta = await uploadToSupabase("lms-files", "tugas", file);

            const { error } = await supabaseClient.from("tugas").insert([{
              judul: title,
              deadline,
              deskripsi: desc,
              ...fileMeta
            }]);
            if (error) throw error;

            await loadTugasMateri();
            msg.textContent = "âœ… Tugas berhasil ditambahkan. Cek menu Siswa > Tugas.";
            if (fileInput) fileInput.value = "";
          }catch(err){
            msg.textContent = "âŒ " + (err?.message || String(err));
          }
        });
      }

      // tambah materi (supabase)
      const btnMat = document.getElementById("btnMat");
      if (btnMat){
        const mapelSelect = document.getElementById("matMapel");
        const diniyahWrap = document.getElementById("diniyahWrap");

        function toggleDiniyah(){
          const isDiniyah = mapelSelect.value === "Diniyah";
          diniyahWrap.style.display = isDiniyah ? "block" : "none";
        }
        mapelSelect.addEventListener("change", toggleDiniyah);
        toggleDiniyah();

        btnMat.addEventListener("click", async () => {
          const title = document.getElementById("matTitle").value.trim();
          const mapel = document.getElementById("matMapel").value;
          const subEl = document.getElementById("matSub");
          const sub = (mapel === "Diniyah" && subEl) ? subEl.value : undefined;

          const type = document.getElementById("matType").value.trim() || "Materi";
          const link = document.getElementById("matLink").value.trim();
          const fileInput = document.getElementById("matFile");
          const msg = document.getElementById("matMsg");

          if (!title){
            msg.textContent = "Judul materi wajib diisi.";
            return;
          }

          msg.textContent = "Mengupload...";
          try{
            const file = fileInput?.files?.[0];
            let fileMeta = {};
            if (file) fileMeta = await uploadToSupabase("lms-files", "materi", file);

            const payload = {
              judul: title,
              tipe: type,
              tanggal: new Date().toISOString().slice(0,10),
              link,
              mapel,
              ...(mapel === "Diniyah" ? { sub: sub || "Lainnya" } : {}),
              ...fileMeta
            };

            const { error } = await supabaseClient.from("materi").insert([payload]);
            if (error) throw error;

            await loadTugasMateri();
            msg.textContent = `âœ… Materi ditambahkan (${mapel}${mapel==="Diniyah" ? " â€¢ " + (payload.sub) : ""}).`;
            if (fileInput) fileInput.value = "";
          }catch(err){
            msg.textContent = "âŒ " + (err?.message || String(err));
          }
        });
      }
    }

    /***********************
     * 9) INIT AUTH + DRAWER
     ***********************/
    async function initAuth(){
      // drawer events
      btnMenu?.addEventListener("click", openMenu);
      overlay?.addEventListener("click", closeMenu);
      menuEl.addEventListener("click", () => {
        if (window.matchMedia("(max-width: 900px)").matches) closeMenu();
      });

      // logout top
      btnLogoutTop.addEventListener("click", async () => { await supabaseClient.auth.signOut(); });
      btnLogout.addEventListener("click", async () => { await supabaseClient.auth.signOut(); });

      // login (pakai timeout biar tidak stuck tanpa pesan)
      btnLogin.addEventListener("click", async (e) => {
        e.preventDefault();

        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPass").value.trim();

        if (!email || !password){
          authStatus.textContent = "Email dan password wajib diisi.";
          return;
        }

        authStatus.textContent = "Memproses login...";

        try{
          const loginPromise = supabaseClient.auth.signInWithPassword({ email, password });
          const timeoutPromise = new Promise((_, rej) =>
            setTimeout(() => rej(new Error("Timeout: tidak bisa menghubungi Supabase. Cek SUPABASE_URL/ANON_KEY, koneksi, atau blocker.")), 15000)
          );

          const { data, error } = await Promise.race([loginPromise, timeoutPromise]);
          if (error) throw error;

          console.log("login ok:", data);
        }catch(err){
          console.error(err);
          authStatus.textContent = "âŒ " + (err?.message || String(err));
        }
      });

      // auth state listener
      supabaseClient.auth.onAuthStateChange(async () => {
        await updateButtons();

        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user){
          try{
            await refreshUIAfterLogin();
          }catch(e){
            console.error(e);
            authStatus.textContent = "âŒ " + (e?.message || String(e));
          }
        } else {
          // reset UI
          currentRole = null;
          sample.tugas = [];
          sample.materi = [];
          state.role = "siswa";
          state.page = "dashboard";

          rolePill.textContent = "Role: -";
          userPill.textContent = "User: -";
          menuHint.textContent = "-";
          menuGroupTitle.textContent = "Siswa";

          renderMenu();
          renderPage();

          document.getElementById("appContent").style.display = "none";
          authStatus.textContent = "Silakan login untuk mengakses LMS.";
        }
      });

      // first render (logged out state)
      renderMenu();
      renderPage();
      await updateButtons();

      // if already logged in
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (user) await refreshUIAfterLogin();
    }

    // expose download function for inline onclick
    window.openDownload = openDownload;

    // start
    document.addEventListener("DOMContentLoaded", () => {
      initAuth();
    });
  </script>
</body>
</html>
