<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LMS Sekolah - Supabase (Mode Sekolah)</title>

  <style>
    :root{
      --blue:#2563eb;
      --blueDark:#1d4ed8;
      --text:#0f172a;
      --muted:#475569;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e5e7eb;
      --radius:18px;
      --shadow: 0 14px 40px rgba(2, 6, 23, .08);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.5;
    }
    a{ color:inherit; text-decoration:none; }
    .container{ width:min(1100px, 92%); margin:0 auto; }

    header{
      position: sticky; top:0; z-index:10;
      background: rgba(248,250,252,.92);
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 0;
      gap: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
    }
    .school-logo{
      width: 42px;
      height: 42px;
      object-fit: contain;
    }
    .rolebox{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
    }
    .pill{
      font-size: 12px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      background: #dbeafe;
      color:#1e40af;
      border: 1px solid #bfdbfe;
      white-space: nowrap;
    }

    .layout{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
      padding: 18px 0 30px;
    }
    @media (max-width: 900px){
      .layout{ grid-template-columns: 1fr; }
    }

    aside{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      height: fit-content;
    }
    .side-title{
      font-weight: 900;
      margin: 0 0 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .menu{
      display:flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }
    .menu button{
      width: 100%;
      text-align: left;
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 800;
      color: var(--muted);
    }
    .menu button:hover{ background:#eff6ff; color: var(--text); border-color:#bfdbfe; }
    .menu button.active{
      background: var(--blue);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 10px 25px rgba(37,99,235,.22);
    }

    main{ display:grid; gap: 14px; }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    h1,h2,h3{ margin:0 0 10px; }
    .muted{ color: var(--muted); margin:0; }

    .list{ display:grid; gap: 10px; margin-top: 12px; }
    .item{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background:#fff;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .meta{ color: var(--muted); font-size: 13px; margin-top: 6px; }
    .badge{
      display:inline-flex;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #bfdbfe;
      background:#eff6ff;
      color:#1e40af;
      font-weight: 800;
      font-size: 12px;
      white-space: nowrap;
      height: fit-content;
    }

    .form{ display:grid; gap: 10px; margin-top: 12px; }
    label{ font-weight: 800; font-size: 13px; color: var(--muted); }
    input, textarea, select{
      width: 100%;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      font: inherit;
      outline: none;
      background:#fff;
    }
    textarea{ min-height: 120px; resize: vertical; }

    .filebox{
      border: 1px dashed #cbd5e1;
      border-radius: 16px;
      background:#fafafa;
      padding: 12px;
      display:grid;
      gap: 8px;
    }
    .filehint{ font-size: 13px; color: var(--muted); }

    .row2{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 560px){
      .row2{ grid-template-columns: 1fr; }
    }

    .actions{ display:flex; gap: 10px; flex-wrap: wrap; }
    .btn{
      border: 1px solid var(--border);
      background: var(--blue);
      color:#fff;
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 25px rgba(37,99,235,.22);
    }
    .btn:hover{ background: var(--blueDark); }
    .btn.secondary{
      background:#fff;
      color: var(--blue);
      border-color:#bfdbfe;
      box-shadow:none;
    }
    .btn.secondary:hover{ background:#eff6ff; }

    /* Auth + App visibility */
    #appContent{ display:none; }
    #authBox{ margin: 14px auto 0; }
  </style>
</head>

<body>

  <header>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <img src="logo-sekolah.png" alt="Logo Duruusul Quran Islamic School Makassar" class="school-logo">
          <div>
            <div style="font-size:14px; font-weight:900;">LMS Sekolah</div>
            <div style="font-size:12px; color:var(--muted); font-weight:700;">Supabase ‚Ä¢ Mode Sekolah</div>
          </div>
        </div>

        <div class="rolebox">
          <span class="pill" id="rolePill">Role: -</span>
          <span class="pill" id="userPill" style="background:#eef2ff;border-color:#c7d2fe;color:#3730a3;">User: -</span>
          <button class="btn secondary" id="btnLogoutTop" style="display:none;">Logout</button>
        </div>
      </div>
    </div>

    <!-- Login box (tetap di header biar jelas) -->
    <section class="card container" id="authBox">
      <h3>Login LMS</h3>
      <p class="muted" id="authStatus">Silakan login untuk mengakses LMS.</p>

      <div class="form" style="max-width:520px;">
        <div>
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="email@sekolah.sch.id" />
        </div>
        <div>
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div class="actions">
          <button class="btn" id="btnLogin">Login</button>
          <button class="btn secondary" id="btnLogout" style="display:none;">Logout</button>
        </div>
      </div>
    </section>
  </header>

  <!-- App (disembunyikan sampai login) -->
  <div id="appContent">
    <div class="container">
      <div class="layout">
        <aside>
          <div class="side-title">
            <span>Menu</span>
            <span class="badge" id="menuHint">-</span>
          </div>
          <div class="menu" id="menu"></div>
        </aside>

        <main>
          <section class="card" id="page"></section>

          <section class="card">
            <h3>Catatan</h3>
            <p class="muted">
              File tugas/materi disimpan di <b>Supabase Storage</b> (permanen). Untuk bucket private, download memakai <b>signed URL</b>.
            </p>
          </section>
        </main>
      </div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /********************************************************************
     * 1) KONFIGURASI SUPABASE
     ********************************************************************/
    const SUPABASE_URL = "ISI_DARI_PROJECT_SETTINGS_API_URL";
    const SUPABASE_ANON_KEY = "ISI_DARI_PROJECT_SETTINGS_API_ANON_KEY";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /********************************************************************
     * 2) KONFIGURASI MAPEL
     ********************************************************************/
    const MAPEL_ORDER = [
      "Bahasa Indonesia",
      "PKN",
      "Hadits",
      "Bahasa Inggris",
      "PJOK",
      "IPA",
      "IPS",
      "Matematika",
      "Tajwid",
      "Prakarya",
      "Diniyah",
      "Bahasa Arab",
    ];
    const DINIYAH_SUB_ORDER = ["Aqidah", "Fiqih", "Tafsir", "Siroh", "Khot"];

    /********************************************************************
     * 3) STATE & MENU
     ********************************************************************/
    const menus = {
      siswa: [
        { key: "dashboard", label: "Dashboard" },
        { key: "tugas", label: "Tugas" },
        { key: "materi", label: "Materi" },
      ],
      guru: [
        { key: "berikan-dashboard", label: "Berikan Dashboard" },
        { key: "berikan-tugas", label: "Berikan Tugas (Upload)" },
        { key: "berikan-materi", label: "Berikan Materi" },
      ]
    };

    const rolePill = document.getElementById("rolePill");
    const userPill = document.getElementById("userPill");
    const menuHint = document.getElementById("menuHint");
    const menuEl = document.getElementById("menu");
    const pageEl = document.getElementById("page");

    const authStatus = document.getElementById("authStatus");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnLogoutTop = document.getElementById("btnLogoutTop");

    const authBox = document.getElementById("authBox");
    const appContent = document.getElementById("appContent");

    let currentRole = null;  // 'guru' atau 'siswa'
    let currentUser = null;  // supabase user

    let state = { role: "siswa", page: "dashboard" };

    // data dari Supabase (di-load setelah login)
    const sample = { tugas: [], materi: [] };

    function setPage(key){
      state.page = key;
      renderMenu();
      renderPage();
    }

    function renderMenu(){
      menuEl.innerHTML = "";
      const items = menus[state.role] || [];
      items.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item.label;
        btn.className = item.key === state.page ? "active" : "";
        btn.addEventListener("click", () => setPage(item.key));
        menuEl.appendChild(btn);
      });
    }

    /********************************************************************
     * 4) PAGES SISWA
     ********************************************************************/
    function pageSiswaDashboard(){
      const totalTugas = sample.tugas.length;
      const tugasDenganFile = sample.tugas.filter(t => t.file_path).length;

      return `
        <h1>Dashboard Siswa</h1>
        <p class="muted">Ringkasan tugas dan materi.</p>

        <div class="list">
          <div class="item">
            <div>
              <strong>Total Tugas</strong>
              <div class="meta">${totalTugas} tugas</div>
            </div>
            <span class="badge">Info</span>
          </div>

          <div class="item">
            <div>
              <strong>Tugas dengan File</strong>
              <div class="meta">${tugasDenganFile} tugas ada lampiran</div>
            </div>
            <span class="badge">File</span>
          </div>

          <div class="item">
            <div>
              <strong>Total Materi</strong>
              <div class="meta">${sample.materi.length} materi</div>
            </div>
            <span class="badge">Info</span>
          </div>
        </div>
      `;
    }

    function pageSiswaTugas(){
      const rows = sample.tugas.map((t) => {
        const filePart = t.file_path
          ? `
            <div class="meta">
              <button class="btn secondary" onclick="openDownload('lms-files','${escapeHtml(t.file_path)}')">
                ‚¨á Download: ${escapeHtml(t.file_name || "Lampiran")}
              </button>
            </div>
            <div class="meta">Ukuran: ${formatBytes(Number(t.file_size) || 0)}</div>
          `
          : `<div class="meta">Lampiran: -</div>`;

        return `
          <div class="item">
            <div>
              <strong>${escapeHtml(t.judul)}</strong>
              <div class="meta">Deadline: ${escapeHtml(t.deadline || "-")}</div>
              ${t.deskripsi ? `<div class="meta">${escapeHtml(t.deskripsi)}</div>` : ""}
              ${filePart}
            </div>
            <span class="badge">Tugas</span>
          </div>
        `;
      }).join("");

      return `
        <h1>Tugas</h1>
        <p class="muted">Daftar tugas. Jika ada file, kamu bisa download.</p>
        <div class="list">${rows || `<p class="muted">Belum ada tugas.</p>`}</div>
      `;
    }

    function pageSiswaMateri(){
      const grouped = new Map();
      sample.materi.forEach(m => {
        const mapel = m.mapel || "Lainnya";
        if (!grouped.has(mapel)) grouped.set(mapel, []);
        grouped.get(mapel).push(m);
      });

      function renderMateriItems(arr){
        const sorted = [...arr].sort((a,b) => String(b.tanggal||"").localeCompare(String(a.tanggal||"")));
        return sorted.map(m => `
          <div class="item">
            <div>
              <strong>${escapeHtml(m.judul)}</strong>
              <div class="meta">Tipe: ${escapeHtml(m.tipe || "-")}</div>
              <div class="meta">Tanggal: ${escapeHtml(m.tanggal || "-")}</div>
              ${m.link ? `<div class="meta"><a class="btn secondary" href="${escapeHtml(m.link)}" target="_blank" rel="noopener">üîó Buka Link</a></div>` : ""}
              ${m.file_path ? `
                <div class="meta">
                  <button class="btn secondary" onclick="openDownload('lms-files','${escapeHtml(m.file_path)}')">
                    ‚¨á Download: ${escapeHtml(m.file_name || "Lampiran")}
                  </button>
                </div>
                <div class="meta">Ukuran: ${formatBytes(Number(m.file_size) || 0)}</div>
              ` : ""}
            </div>
            <span class="badge">Materi</span>
          </div>
        `).join("");
      }

      function renderMapelBlock(mapelName){
        const arr = grouped.get(mapelName) || [];
        if (arr.length === 0) return "";
        return `
          <div style="margin-top:14px;">
            <h3 style="margin:0 0 8px;">${escapeHtml(mapelName)}</h3>
            <div class="list">${renderMateriItems(arr)}</div>
          </div>
        `;
      }

      function renderDiniyahBlock(){
        const arr = grouped.get("Diniyah") || [];
        if (arr.length === 0) return "";

        const subGrouped = new Map();
        arr.forEach(m => {
          const sub = (m.sub || "Lainnya").trim();
          if (!subGrouped.has(sub)) subGrouped.set(sub, []);
          subGrouped.get(sub).push(m);
        });

        const subs = [
          ...DINIYAH_SUB_ORDER.filter(s => subGrouped.has(s)),
          ...[...subGrouped.keys()].filter(s => !DINIYAH_SUB_ORDER.includes(s)),
        ];

        const subBlocks = subs.map(sub => `
          <div style="margin-top:10px; padding:12px; border:1px solid var(--border); border-radius:16px; background:#fff;">
            <strong style="display:block; margin-bottom:8px;">${escapeHtml(sub)}</strong>
            <div class="list">${renderMateriItems(subGrouped.get(sub))}</div>
          </div>
        `).join("");

        return `
          <div style="margin-top:14px;">
            <h3 style="margin:0 0 8px;">Diniyah</h3>
            ${subBlocks}
          </div>
        `;
      }

      const blocks = MAPEL_ORDER
        .filter(m => m !== "Diniyah")
        .map(renderMapelBlock)
        .join("");

      const diniyah = renderDiniyahBlock();

      return `
        <h1>Materi</h1>
        <p class="muted">Materi pembelajaran dikelompokkan berdasarkan mata pelajaran.</p>
        ${sample.materi.length === 0 ? `<p class="muted" style="margin-top:10px;">Belum ada materi.</p>` : ""}
        ${blocks}
        ${diniyah}
      `;
    }

    /********************************************************************
     * 5) PAGES GURU
     ********************************************************************/
    function pageGuruBerikanDashboard(){
      return `
        <h1>Berikan Dashboard</h1>
        <p class="muted">Contoh halaman untuk menulis pengumuman (tampilan saja).</p>

        <form class="form" onsubmit="return false;">
          <div>
            <label>Judul Pengumuman</label>
            <input id="annTitle" placeholder="Contoh: Ulangan Pekan Ini" />
          </div>
          <div>
            <label>Isi Pengumuman</label>
            <textarea id="annBody" placeholder="Tulis informasi untuk siswa..."></textarea>
          </div>
          <div class="actions">
            <button class="btn" id="btnAnn">Publikasikan</button>
            <button class="btn secondary" type="reset">Reset</button>
          </div>
          <p class="muted" id="annMsg" style="margin-top:8px;"></p>
        </form>
      `;
    }

    function pageGuruBerikanTugas(){
      return `
        <h1>Berikan Tugas (Upload File)</h1>
        <p class="muted">Isi judul + deadline + upload lampiran. (Supabase Storage)</p>

        <form class="form" onsubmit="return false;">
          <div>
            <label>Judul Tugas</label>
            <input id="taskTitle" placeholder="Contoh: Tugas IPA Bab 2" />
          </div>

          <div>
            <label>Deadline</label>
            <input id="taskDeadline" type="date" />
          </div>

          <div class="filebox">
            <label>Upload File Lampiran (opsional)</label>
            <input id="taskFile" type="file" />
            <div class="filehint">PDF/DOCX/ZIP, dll. (Upload permanen ke Supabase Storage)</div>
          </div>

          <div>
            <label>Deskripsi (opsional)</label>
            <textarea id="taskDesc" placeholder="Instruksi tugas..."></textarea>
          </div>

          <div class="actions">
            <button class="btn" id="btnTask">Tambahkan Tugas</button>
            <button class="btn secondary" type="reset">Reset</button>
          </div>

          <p class="muted" id="taskMsg" style="margin-top:8px;"></p>
        </form>
      `;
    }

    function pageGuruBerikanMateri(){
      const mapelOptions = MAPEL_ORDER.map(m => `<option value="${m}">${m}</option>`).join("");
      const diniyahOptions = DINIYAH_SUB_ORDER.map(s => `<option value="${s}">${s}</option>`).join("");

      return `
        <h1>Berikan Materi</h1>
        <p class="muted">Tambah materi (judul + mapel + tipe + link + upload file). (Supabase)</p>

        <form class="form" onsubmit="return false;">
          <div>
            <label>Judul Materi</label>
            <input id="matTitle" placeholder="Contoh: Sistem Pencernaan" />
          </div>

          <div class="row2">
            <div>
              <label>Mata Pelajaran</label>
              <select id="matMapel">${mapelOptions}</select>
            </div>

            <div id="diniyahWrap" style="display:none;">
              <label>Sub Diniyah</label>
              <select id="matSub">${diniyahOptions}</select>
            </div>
          </div>

          <div>
            <label>Tipe Materi</label>
            <input id="matType" placeholder="Contoh: PDF / Video / Slide" />
          </div>

          <div class="filebox">
            <label>Upload File Materi (opsional)</label>
            <input id="matFile" type="file" />
            <div class="filehint">PDF/DOCX/PPTX. (Upload permanen ke Supabase Storage)</div>
          </div>

          <div>
            <label>Link / Konten (opsional)</label>
            <textarea id="matLink" placeholder="Tempel link Google Drive / YouTube / teks materi..."></textarea>
          </div>

          <div class="actions">
            <button class="btn" id="btnMat">Tambahkan Materi</button>
            <button class="btn secondary" type="reset">Reset</button>
          </div>
          <p class="muted" id="matMsg" style="margin-top:8px;"></p>
        </form>
      `;
    }

    function renderPage(){
      const r = state.role;
      const p = state.page;

      if (r === "siswa"){
        if (p === "dashboard") pageEl.innerHTML = pageSiswaDashboard();
        if (p === "tugas") pageEl.innerHTML = pageSiswaTugas();
        if (p === "materi") pageEl.innerHTML = pageSiswaMateri();
      } else {
        if (p === "berikan-dashboard") pageEl.innerHTML = pageGuruBerikanDashboard();
        if (p === "berikan-tugas") pageEl.innerHTML = pageGuruBerikanTugas();
        if (p === "berikan-materi") pageEl.innerHTML = pageGuruBerikanMateri();
      }

      wireHandlers();
    }

    /********************************************************************
     * 6) HANDLERS (setelah render)
     ********************************************************************/
    function wireHandlers(){
      // Pengumuman (dummy)
      const btnAnn = document.getElementById("btnAnn");
      if (btnAnn){
        btnAnn.addEventListener("click", () => {
          const title = document.getElementById("annTitle").value.trim();
          const body = document.getElementById("annBody").value.trim();
          const msg = document.getElementById("annMsg");
          if (!title || !body){
            msg.textContent = "Judul dan isi pengumuman wajib diisi.";
            return;
          }
          msg.textContent = "‚úÖ Pengumuman dipublikasikan (tampilan saja).";
        });
      }

      // Guru: tambah tugas + upload file (Supabase)
      const btnTask = document.getElementById("btnTask");
      if (btnTask){
        btnTask.addEventListener("click", async () => {
          const title = document.getElementById("taskTitle").value.trim();
          const deadline = document.getElementById("taskDeadline").value;
          const desc = document.getElementById("taskDesc").value.trim();
          const fileInput = document.getElementById("taskFile");
          const msg = document.getElementById("taskMsg");

          if (!title || !deadline){
            msg.textContent = "Judul dan deadline wajib diisi.";
            return;
          }

          msg.textContent = "Mengupload...";
          try{
            const file = fileInput?.files?.[0];
            let fileMeta = {};
            if (file) fileMeta = await uploadToSupabase("lms-files", "tugas", file);

            const { error } = await supabaseClient.from("tugas").insert([{
              judul: title,
              deadline,
              deskripsi: desc,
              ...fileMeta,
              created_by: currentUser?.id || null
            }]);

            if (error) throw error;

            await loadTugasMateri();
            msg.textContent = "‚úÖ Tugas berhasil ditambahkan.";
            if (fileInput) fileInput.value = "";
          }catch(err){
            msg.textContent = "‚ùå " + err.message;
          }
        });
      }

      // Guru: tambah materi + upload file (Supabase)
      const btnMat = document.getElementById("btnMat");
      if (btnMat){
        const mapelSelect = document.getElementById("matMapel");
        const diniyahWrap = document.getElementById("diniyahWrap");

        function toggleDiniyah(){
          const isDiniyah = mapelSelect.value === "Diniyah";
          diniyahWrap.style.display = isDiniyah ? "block" : "none";
        }
        mapelSelect.addEventListener("change", toggleDiniyah);
        toggleDiniyah();

        btnMat.addEventListener("click", async () => {
          const title = document.getElementById("matTitle").value.trim();
          const mapel = document.getElementById("matMapel").value;
          const subEl = document.getElementById("matSub");
          const sub = (mapel === "Diniyah" && subEl) ? subEl.value : undefined;

          const type = document.getElementById("matType").value.trim() || "Materi";
          const link = document.getElementById("matLink").value.trim();
          const fileInput = document.getElementById("matFile");
          const msg = document.getElementById("matMsg");

          if (!title){
            msg.textContent = "Judul materi wajib diisi.";
            return;
          }

          msg.textContent = "Mengupload...";
          try{
            const file = fileInput?.files?.[0];
            let fileMeta = {};
            if (file) fileMeta = await uploadToSupabase("lms-files", "materi", file);

            const payload = {
              judul: title,
              tipe: type,
              tanggal: new Date().toISOString().slice(0,10),
              link,
              mapel,
              ...(mapel === "Diniyah" ? { sub: sub || "Lainnya" } : {}),
              ...fileMeta,
              created_by: currentUser?.id || null
            };

            const { error } = await supabaseClient.from("materi").insert([payload]);
            if (error) throw error;

            await loadTugasMateri();
            msg.textContent = `‚úÖ Materi ditambahkan (${mapel}${mapel==="Diniyah" ? " ‚Ä¢ " + (payload.sub) : ""}).`;
            if (fileInput) fileInput.value = "";
          }catch(err){
            msg.textContent = "‚ùå " + err.message;
          }
        });
      }
    }

    /********************************************************************
     * 7) SUPABASE HELPERS: upload & download
     ********************************************************************/
    async function uploadToSupabase(bucket, folder, file){
      const ext = file.name.split(".").pop();
      const safeExt = (ext || "bin").replace(/[^\w]+/g, "");
      const path = `${folder}/${Date.now()}-${Math.random().toString(16).slice(2)}.${safeExt}`;

      const { error } = await supabaseClient.storage.from(bucket).upload(path, file, { upsert: false });
      if (error) throw error;

      return { file_path: path, file_name: file.name, file_size: file.size };
    }

    // expose ke window agar bisa dipakai onclick
    window.openDownload = async function(bucket, file_path){
      try{
        const { data, error } = await supabaseClient.storage.from(bucket).createSignedUrl(file_path, 60 * 10);
        if (error) throw error;
        window.open(data.signedUrl, "_blank");
      }catch(e){
        alert("Gagal download: " + e.message);
      }
    };

    async function fetchMyRole(){
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) return null;

      const { data, error } = await supabaseClient
        .from("profiles")
        .select("role, full_name")
        .eq("id", user.id)
        .single();

      if (error) throw error;
      return data?.role || null;
    }

    async function loadTugasMateri(){
      const { data: tugas, error: e1 } = await supabaseClient
        .from("tugas").select("*").order("created_at", { ascending: false });
      if (e1) throw e1;

      const { data: materi, error: e2 } = await supabaseClient
        .from("materi").select("*").order("created_at", { ascending: false });
      if (e2) throw e2;

      sample.tugas = tugas || [];
      sample.materi = materi || [];
    }

    /********************************************************************
     * 8) AUTH FLOW
     ********************************************************************/
    async function refreshUIAfterLogin(){
      const { data: { user } } = await supabaseClient.auth.getUser();
      currentUser = user || null;

      currentRole = await fetchMyRole(); // 'guru' / 'siswa'
      const roleLabel = (currentRole === "guru") ? "Guru" : "Siswa";

      rolePill.textContent = "Role: " + roleLabel;
      menuHint.textContent = roleLabel;
      userPill.textContent = "User: " + (currentUser?.email || "-");

      state.role = (currentRole === "guru") ? "guru" : "siswa";
      state.page = (state.role === "guru") ? "berikan-dashboard" : "dashboard";

      await loadTugasMateri();
      renderMenu();
      renderPage();

      appContent.style.display = "block";
      authBox.style.display = "none";
      btnLogoutTop.style.display = "inline-block";

      authStatus.textContent = "‚úÖ Login berhasil.";
    }

    async function updateAuthButtons(){
      const { data: { user } } = await supabaseClient.auth.getUser();
      const isLoggedIn = !!user;
      btnLogin.style.display = isLoggedIn ? "none" : "inline-block";
      btnLogout.style.display = isLoggedIn ? "inline-block" : "none";
    }

    async function initAuth(){
      btnLogin.addEventListener("click", async () => {
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPass").value.trim();
        authStatus.textContent = "Memproses login...";

        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) authStatus.textContent = "‚ùå " + error.message;
      });

      async function doLogout(){
        await supabaseClient.auth.signOut();
      }
      btnLogout.addEventListener("click", doLogout);
      btnLogoutTop.addEventListener("click", doLogout);

      supabaseClient.auth.onAuthStateChange(async () => {
        await updateAuthButtons();
        const { data: { user } } = await supabaseClient.auth.getUser();

        if (user){
          try{
            await refreshUIAfterLogin();
          }catch(e){
            authBox.style.display = "block";
            appContent.style.display = "none";
            btnLogoutTop.style.display = "none";
            authStatus.textContent = "‚ùå " + e.message;
          }
        } else {
          // logged out
          currentUser = null;
          currentRole = null;

          sample.tugas = [];
          sample.materi = [];

          rolePill.textContent = "Role: -";
          menuHint.textContent = "-";
          userPill.textContent = "User: -";

          state.role = "siswa";
          state.page = "dashboard";

          renderMenu();
          pageEl.innerHTML = `<h1>Silakan login</h1><p class="muted">Masuk untuk melihat menu siswa/guru.</p>`;

          appContent.style.display = "none";
          authBox.style.display = "block";
          btnLogoutTop.style.display = "none";
          authStatus.textContent = "Silakan login untuk mengakses LMS.";
        }
      });

      await updateAuthButtons();

      // Auto-refresh kalau sudah login sebelumnya
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (user) {
        try { await refreshUIAfterLogin(); }
        catch(e){ authStatus.textContent = "‚ùå " + e.message; }
      } else {
        // initial logged out view
        renderMenu();
        pageEl.innerHTML = `<h1>Silakan login</h1><p class="muted">Masuk untuk melihat menu siswa/guru.</p>`;
      }
    }

    /********************************************************************
     * 9) HELPERS
     ********************************************************************/
    function formatBytes(bytes){
      if (!Number.isFinite(bytes) || bytes <= 0) return "-";
      const units = ["B","KB","MB","GB"];
      let i = 0, n = bytes;
      while (n >= 1024 && i < units.length - 1){
        n = n / 1024;
        i++;
      }
      return n.toFixed(i === 0 ? 0 : 1) + " " + units[i];
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // init
    initAuth();
  </script>
</body>
</html>
